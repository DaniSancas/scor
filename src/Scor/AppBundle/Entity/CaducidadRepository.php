<?php

namespace Scor\AppBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * CaducidadRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CaducidadRepository extends EntityRepository
{
    /**
     * Devuelve todas aquellas licencias que caduquen en 1..3 meses
     * No se devolverÃ¡n aquellas a las que se haya desactivado el aviso (mandaAviso == false)
     *
     * @param int $meses
     * @return array Caducidades
     */
    public function findCaducidadByMeses($meses = 1)
    {
        $q = $this->getEntityManager()->createQuery('SELECT c FROM AppBundle:Caducidad c WHERE c.fecha >= :inicio AND c.fecha < :fin AND c.mandaAviso = true');

        switch($meses)
        {
            case 3:
                $inicio = '+2 month';
                $fin = '+3 month';
                break;
            case 2:
                $inicio = '+1 month';
                $fin = '+2 month';
                break;
            default:
                $inicio = 'now';
                $fin = '+1 month';
                break;
        }

        $q->setParameter('inicio', new \DateTime($inicio));
        $q->setParameter('fin', new \DateTime($fin));

        return $q->getResult();
    }
}
